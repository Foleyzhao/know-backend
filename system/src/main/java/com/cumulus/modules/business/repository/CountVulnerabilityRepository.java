package com.cumulus.modules.business.repository;
import java.util.List;
import java.util.Map;
import com.cumulus.modules.business.entity.CountVulnerability;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;

/**
 * 风险统计数据访问接口
 *
 * @author Shijh
 */
public interface CountVulnerabilityRepository extends JpaRepository<CountVulnerability, Integer>, JpaSpecificationExecutor<CountVulnerability> {

    /**
     * 风险趋势统计
     *
     * @return 结果集
     */
    @Query(value = "select\n" +
            "a.click_date,\n" +
            " ifnull(b.n,0) '低危',\n" +
            "  ifnull(b.nn,0) '中危',\n" +
            "\t ifnull(b.nnn,0) '高危'\n" +
            "from (\n" +
            "SELECT date_sub(curdate(), interval 1 day) as click_date\n" +
            "union all\n" +
            "SELECT date_sub(curdate(), interval 2 day) as click_date\n" +
            "union all\n" +
            "SELECT date_sub(curdate(), interval 3 day) as click_date\n" +
            "union all\n" +
            "SELECT date_sub(curdate(), interval 4 day) as click_date\n" +
            "union all\n" +
            "SELECT date_sub(curdate(), interval 5 day) as click_date\n" +
            "union all \n" +
            "SELECT date_sub(curdate(), interval 6 day) as click_date\n" +
            "union all \n" +
            "SELECT date_sub(curdate(), interval 7 day) as click_date\n" +
            "union all \n" +
            "SELECT date_sub(curdate(), interval 8 day) as click_date\n" +
            "union all \n" +
            "SELECT date_sub(curdate(), interval 9 day) as click_date\n" +
            "union all \n" +
            "SELECT date_sub(curdate(), interval 10 day) as click_date\n" +
            "union all \n" +
            "SELECT date_sub(curdate(), interval 11 day) as click_date\n" +
            "union all \n" +
            "SELECT date_sub(curdate(), interval 12 day) as click_date\n" +
            "union all \n" +
            "SELECT date_sub(curdate(), interval 13 day) as click_date\n" +
            "union all \n" +
            "SELECT date_sub(curdate(), interval 14 day) as click_date\n" +
            "union all \n" +
            "SELECT date_sub(curdate(), interval 15 day) as click_date\n" +
            ") a left join (\n" +
            "select date(DATE_FORMAT(create_time,'%y-%m-%d')) as datetime,\n" +
            "low_risk_num n,\n" +
            "in_danger_num nn,\n" +
            "high_num nnn\n" +
            "from count_vulnerability\n" +
            "group by datetime\n" +
            ") b \n" +
            "on a.click_date = b.datetime \n" +
            "order by a.click_date desc;",nativeQuery = true)
    List<Map<String, Object>> findRiskTrend();
}
